<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFB Rankings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
    <div id="root" class="min-h-screen p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-trophy text-yellow-500 text-3xl"></i>
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800">College Football Rankings <span id="yearDisplay">2024</span></h1>
                            <p class="text-slate-600 text-sm">FBS • Regular Season</p>
                        </div>
                    </div>
                    <button onclick="fetchRankings()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                <p class="text-slate-600">Custom ranking system based on wins, strength of schedule, and margin of victory. The intention of these rankings is to determine who has had the best season at the end of the season. Rankings fluctuate week to week as prior opponents revel themselves to be who they actually are. </p>
            </div>

            <!-- Controls -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="md:w-32">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Year</label>
                        <select id="yearSelect" onchange="fetchRankings()" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                            <option value="2016">2016</option>
                            <option value="2015">2015</option>
                        </select>
                    </div>
                    <div class="md:w-32">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Week</label>
                        <select id="weekSelect" onchange="fetchRankings()" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Weeks</option>
                            <option value="1">Week 1</option>
                            <option value="2">Week 2</option>
                            <option value="3">Week 3</option>
                            <option value="4">Week 4</option>
                            <option value="5">Week 5</option>
                            <option value="6">Week 6</option>
                            <option value="7">Week 7</option>
                            <option value="8">Week 8</option>
                            <option value="9">Week 9</option>
                            <option value="10">Week 10</option>
                            <option value="11">Week 11</option>
                            <option value="12">Week 12</option>
                            <option value="13">Week 13</option>
                            <option value="14">Week 14</option>
                            <option value="15">Week 15</option>
                        </select>
                    </div>
                    <div class="md:w-48">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Season Type</label>
                        <select id="seasonSelect" onchange="fetchRankings()" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="regular">Regular Season</option>
                            <option value="both">Regular + Postseason</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Search Teams</label>
                        <input type="text" id="searchInput" placeholder="Filter by team name..." onkeyup="filterTeams()" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="md:w-48">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Sort By</label>
                        <select id="sortSelect" onchange="filterTeams()" 
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="rank">Ranking</option>
                            <option value="name">Team Name</option>
                            <option value="wins">Wins</option>
                            <option value="record">Win %</option>
                        </select>
                    </div>
                </div>

                <!-- Formula Customization Toggle -->
                <div class="border-t border-slate-200 pt-4">
                    <button onclick="toggleFormulaControls()" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium">
                        <i id="formulaToggleIcon" class="fas fa-chevron-down"></i>
                        <span>Customize Ranking Formula</span>
                    </button>
                    
                    <div id="formulaControls" class="hidden mt-4 p-4 bg-slate-50 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Base Value -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Base Value
                                    <span class="text-xs text-slate-500">(default: 1.0)</span>
                                </label>
                                <input type="number" id="baseValue" value="1.0" step="0.1" min="0" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Win/Loss Multiplier -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Win/Loss Impact
                                    <span class="text-xs text-slate-500">(default: 1.0)</span>
                                </label>
                                <input type="number" id="winLossMultiplier" value="1.0" step="0.1" min="0" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Margin Threshold 1 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Close Game Margin
                                    <span class="text-xs text-slate-500">(default: 8)</span>
                                </label>
                                <input type="number" id="marginThreshold1" value="8" step="1" min="0" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Margin Multiplier 1 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Close Game Mult.
                                    <span class="text-xs text-slate-500">(default: 1.0)</span>
                                </label>
                                <input type="number" id="marginMultiplier1" value="1.0" step="0.1" min="0" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Margin Threshold 2 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Medium Win Margin
                                    <span class="text-xs text-slate-500">(default: 16)</span>
                                </label>
                                <input type="number" id="marginThreshold2" value="16" step="1" min="0" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Margin Multiplier 2 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Medium Win Mult.
                                    <span class="text-xs text-slate-500">(default: 1.5)</span>
                                </label>
                                <input type="number" id="marginMultiplier2" value="1.5" step="0.1" min="0" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Margin Multiplier 3 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Blowout Mult.
                                    <span class="text-xs text-slate-500">(default: 2.0)</span>
                                </label>
                                <input type="number" id="marginMultiplier3" value="2.0" step="0.1" min="0" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- Opponent Strength Divisor -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">
                                    Opp. Strength Factor
                                    <span class="text-xs text-slate-500">(default: 100)</span>
                                </label>
                                <input type="number" id="opponentStrengthDivisor" value="100" step="10" min="1" 
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="applyFormula()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-calculator"></i>
                                Apply Formula
                            </button>
                            <button onclick="resetFormula()" class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors">
                                <i class="fas fa-undo"></i>
                                Reset to Defaults
                            </button>
                        </div>

                        <div class="mt-3 text-sm text-slate-600">
                            <p><strong>Formula:</strong> (Base × Win/Loss × Margin Multiplier) + (Opponent Rank ÷ Strength Factor)</p>
                            <p class="mt-1"><strong>Margin Tiers:</strong> ≤<span id="displayThreshold1">8</span>pts = <span id="displayMult1">1.0</span>x, ≤<span id="displayThreshold2">16</span>pts = <span id="displayMult2">1.5</span>x, ><span id="displayThreshold2_2">16</span>pts = <span id="displayMult3">2.0</span>x</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading/Error -->
            <div id="loadingBox" class="bg-white rounded-lg shadow-lg p-8 text-center">
                <i class="fas fa-spinner fa-spin text-blue-600 text-4xl mb-4"></i>
                <p class="text-xl text-slate-700">Loading rankings...</p>
            </div>

            <div id="errorBox" style="display:none" class="bg-white rounded-lg shadow-lg p-8 text-center">
                <i class="fas fa-exclamation-circle text-red-500 text-4xl mb-4"></i>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Error Loading Rankings</h2>
                <p class="text-slate-600 mb-4" id="errorText"></p>
                <button onclick="fetchRankings()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Try Again</button>
            </div>

            <!-- Rankings Table -->
            <div id="tableBox" style="display:none" class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left">Rank</th>
                                <th class="px-4 py-3 text-left">Team</th>
                                <th class="px-4 py-3 text-center">Record</th>
                                <th class="px-4 py-3 text-right">Rating</th>
                                <th class="px-4 py-3 text-center">Details</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-6 bg-white rounded-lg shadow-lg p-4 text-sm text-slate-600">
                <p class="mb-2"><strong>Rating Formula:</strong> Base value × Win/Loss × Margin Factor + Opponent Strength</p>
                <p>Showing <span id="teamCount">0</span> teams</p>
            </div>
        </div>
    </div>

    <script>
        let allTeams = [];
        const API_URL = '';

        function toggleFormulaControls() {
            const controls = document.getElementById('formulaControls');
            const icon = document.getElementById('formulaToggleIcon');
            if (controls.classList.contains('hidden')) {
                controls.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                controls.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function resetFormula() {
            document.getElementById('baseValue').value = '1.0';
            document.getElementById('winLossMultiplier').value = '1.0';
            document.getElementById('marginThreshold1').value = '8';
            document.getElementById('marginMultiplier1').value = '1.0';
            document.getElementById('marginThreshold2').value = '16';
            document.getElementById('marginMultiplier2').value = '1.5';
            document.getElementById('marginMultiplier3').value = '2.0';
            document.getElementById('opponentStrengthDivisor').value = '100';
            updateFormulaDisplay();
        }

        function applyFormula() {
            updateFormulaDisplay();
            fetchRankings();
        }

        function updateFormulaDisplay() {
            document.getElementById('displayThreshold1').textContent = document.getElementById('marginThreshold1').value;
            document.getElementById('displayThreshold2').textContent = document.getElementById('marginThreshold2').value;
            document.getElementById('displayThreshold2_2').textContent = document.getElementById('marginThreshold2').value;
            document.getElementById('displayMult1').textContent = document.getElementById('marginMultiplier1').value;
            document.getElementById('displayMult2').textContent = document.getElementById('marginMultiplier2').value;
            document.getElementById('displayMult3').textContent = document.getElementById('marginMultiplier3').value;
        }

        function getFormulaParams() {
            return {
                base_value: parseFloat(document.getElementById('baseValue').value),
                win_loss_multiplier: parseFloat(document.getElementById('winLossMultiplier').value),
                margin_threshold_1: parseInt(document.getElementById('marginThreshold1').value),
                margin_multiplier_1: parseFloat(document.getElementById('marginMultiplier1').value),
                margin_threshold_2: parseInt(document.getElementById('marginThreshold2').value),
                margin_multiplier_2: parseFloat(document.getElementById('marginMultiplier2').value),
                margin_multiplier_3: parseFloat(document.getElementById('marginMultiplier3').value),
                opponent_strength_divisor: parseFloat(document.getElementById('opponentStrengthDivisor').value)
            };
        }

        async function fetchRankings() {
            document.getElementById('loadingBox').style.display = 'block';
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('tableBox').style.display = 'none';

            const year = document.getElementById('yearSelect').value;
            const seasonType = document.getElementById('seasonSelect').value;
            const week = document.getElementById('weekSelect').value;
            document.getElementById('yearDisplay').textContent = year;

            try {
                const params = getFormulaParams();
                let url = `${API_URL}/rankings?year=${year}&season_type=${seasonType}`;
                if (week) {
                    url += `&week=${week}`;
                }
                
                // Add formula parameters
                url += `&base_value=${params.base_value}`;
                url += `&win_loss_multiplier=${params.win_loss_multiplier}`;
                url += `&margin_threshold_1=${params.margin_threshold_1}`;
                url += `&margin_multiplier_1=${params.margin_multiplier_1}`;
                url += `&margin_threshold_2=${params.margin_threshold_2}`;
                url += `&margin_multiplier_2=${params.margin_multiplier_2}`;
                url += `&margin_multiplier_3=${params.margin_multiplier_3}`;
                url += `&opponent_strength_divisor=${params.opponent_strength_divisor}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API returned ${response.status}`);
                
                const data = await response.json();
                allTeams = data.teams;
                
                document.getElementById('loadingBox').style.display = 'none';
                document.getElementById('tableBox').style.display = 'block';
                filterTeams();
                document.getElementById('teamCount').textContent = allTeams.length;
            } catch (error) {
                document.getElementById('loadingBox').style.display = 'none';
                document.getElementById('errorBox').style.display = 'block';
                document.getElementById('errorText').textContent = error.message;
            }
        }

        function filterTeams() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortSelect').value;
            
            let filtered = allTeams.filter(t => t.name.toLowerCase().includes(searchText));
            
            // Sort
            if (sortBy === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'wins') {
                filtered.sort((a, b) => b.wins - a.wins);
            } else if (sortBy === 'record') {
                filtered.sort((a, b) => {
                    const aWinPct = a.wins / (a.wins + a.losses);
                    const bWinPct = b.wins / (b.wins + b.losses);
                    return bWinPct - aWinPct;
                });
            } else {
                filtered.sort((a, b) => b.ranking - a.ranking);
            }

            displayTeams(filtered);
        }

        function displayTeams(teams) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            teams.forEach((team, index) => {
                const rankColor = getRankColor(team.ranking);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-slate-50 cursor-pointer';
                row.innerHTML = `
                    <td class="px-4 py-3 font-semibold text-slate-700">#${index + 1}</td>
                    <td class="px-4 py-3 font-semibold text-slate-800">${team.name}</td>
                    <td class="px-4 py-3 text-center font-mono">${team.wins}-${team.losses}</td>
                    <td class="px-4 py-3 text-right font-mono text-lg ${rankColor}">${team.ranking.toFixed(2)}</td>
                    <td class="px-4 py-3 text-center"><i class="fas fa-chevron-down text-slate-400"></i></td>
                `;
                row.onclick = () => toggleDetails(team, row);
                tbody.appendChild(row);
            });
        }

        function toggleDetails(team, row) {
            const existing = row.nextElementSibling;
            if (existing && existing.classList.contains('details-row')) {
                existing.remove();
                return;
            }
            
            const detailsRow = document.createElement('tr');
            detailsRow.className = 'details-row bg-slate-50';
            
            let gamesHtml = team.games.map(g => {
                const resultClass = g.won ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const resultText = g.won ? 'W' : 'L';
                const marginClass = g.margin > 0 ? 'text-green-600' : 'text-red-600';
                const rankColor = getRankColor(g.opponent_rank);
                
                return `
                    <div class="flex items-center justify-between p-2 bg-white rounded border border-slate-200 text-sm">
                        <div class="flex items-center gap-3 flex-1">
                            <span class="font-bold px-2 py-1 rounded ${resultClass}">${resultText}</span>
                            <span class="font-medium text-slate-700">vs ${g.opponent}</span>
                            <span class="text-slate-500 font-mono text-xs">(${g.opponent_record})</span>
                        </div>
                        <div class="flex items-center gap-4 text-xs">
                            <div class="text-right">
                                <div class="text-slate-500">Opp Rank</div>
                                <div class="font-mono font-semibold ${rankColor}">${g.opponent_rank.toFixed(2)}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-slate-500">Margin</div>
                                <div class="font-mono font-semibold ${marginClass}">${g.margin > 0 ? '+' : ''}${g.margin}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-slate-500">Value</div>
                                <div class="font-mono font-semibold text-blue-600">${g.value.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            detailsRow.innerHTML = `
                <td colspan="5" class="px-4 py-4">
                    <h3 class="font-bold text-lg text-slate-800 mb-3">${team.name} Game Results</h3>
                    <div class="space-y-1">${gamesHtml}</div>
                </td>
            `;
            
            row.after(detailsRow);
        }

        function getRankColor(rank) {
            if (rank > 15) return 'text-green-600 font-bold';
            if (rank > 10) return 'text-green-700';
            if (rank > 5) return 'text-blue-600';
            if (rank > 0) return 'text-gray-700';
            if (rank > -5) return 'text-orange-600';
            return 'text-red-600';
        }

        // Load on page load
        fetchRankings();
    </script>
</body>
</html>